$now = Get-Date
$date = $now.tostring("yyyy-MM-dd") 

# Output file path 
$outputFile = "C:\MaintenanceBats\EPFD_AVL\EPFDUnitStatus"


#Log file 
$logfolder = "C:\MaintenanceBats\EPFD_AVL\Logs"
$logname = "epfd_avl_log"
$time = get-date -format "hh:mm"
$logname = "$logfolder\"+"$logname"
$outputarchive = "C:\MaintenanceBats\AVL\Logs\outputcopy"
$logname_pattern = "epfd_avl*"

#database connection & query
$db_aog = @("dbaol")
$query = "SET NOCOUNT ON; EXEC [LIVE].[dbo].[AVL_Status]"
$header1 = '"Unit","Vehicle ID","Event Number","Status","Latitude","Longitude"'
$header2 = '"String","String","String","String","String","String"'



# ==== Query & File Export ==== #
#query exection
while ($true) {
$time = (Get-date).tostring("HH:mm")
    try {

        $sqlcmdArgs = @(
            "-S", $db_aog,     #server/avail.group
            "-E"               #current user credentials
            "-Q", "`"$query`"",#query
            "-s", ",",         # CSV delimiter
            "-W",              # Trim trailing spaces
            "-h", "-1"         # Remove dashed line under headers
        )
       $output = sqlcmd @sqlcmdArgs 

$output | Out-File -FilePath $outputFile -Encoding utf8


# ==== Logging === # 

# import csv for row count
$output | Out-File -FilePath $outputarchive -Encoding utf8
$rowCount = (Import-Csv $outputarchive).Count
    Write-Host "Row count: $rowCount"


# Read the latest write-time of latest log file
$latestlogFile = Get-ChildItem -Path $logfolder -Filter $logname_pattern |
    Sort-Object LastWriteTime -Descending |
    Select-Object -First 1

$lastlogtime = $latestlogFile.LastWriteTime


#Calculate duration between last log file write and now  
$now2 = get-date
$duration = New-TimeSpan -Start $lastlogtime -End $now2
$dur_seconds = [math]::round($duration.TotalSeconds)


# Log success 
if ($LASTEXITCODE -EQ 0) 
    {
        $date2 = Get-Date -Format "yyyy-MM-dd"  
        $ts1 = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $logfile = $logname+"_$date.txt"
        $logEntry = "$ts1 SUCCESS : $outputFile ; row count=$rowcount"
        Add-Content -Path $logFile -Value $logEntry
    }

# Log error if database connection fails, output file path fails and/or query fails
$ts2 = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
$sql_error = & sqlcmd @sqlcmdArgs 2>&1  
if ($LASTEXITCODE -ne 0  ) 
    {
         $logerror_output = "$ts2 ERROR : $sql_error"
         Add-Content -Path $logFile -Value $logerror_output
    }

# Log error if last log write is older than 600 seconds
if ($dur_seconds -ge 600 ) 
    {
         $logerror_logging = "$ts2 ERROR : logging"
         Add-Content -Path $logFile -Value $logerror_logging
    }

}
#capture powershell errors
catch {
        $ts2 = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $message = "$ts2 ERROR: $_"
        Add-Content -Path $logFile -Value $message 
    }

# === Delete LogFiles === #

#At a 00:13 everyday, execute script for delete log files older than 7 days

$logdeletetime = "00:13" 
$logRetentionDays = -7
$now3 = (Get-date).tostring("HH:mm")

if( $now3 -eq $logdeletetime)
{
$getlogrecord =  Get-ChildItem -Path $logfolder -File | Where-Object {$_.Name.ToLower().StartsWith("epfd_avl_log") -and $_.LastWriteTime -lt $now.adddays($logRetentionDays)}


#Log successful deletion of log files
foreach ($file in $getlogrecord) 
{
    try {
        Remove-Item -Path $file.FullName -Force -ErrorAction Stop
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $logEntry = "$timestamp - DELETED: $($file.FullName)"
        Add-Content -Path $logFile -Value $logEntry
    }
    catch {
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $errorLog = "$timestamp - ERROR log delete: $($file.FullName) - $_"
        Add-Content -Path $logFile -Value $errorLog
    }
}

}

## Email Alert Upon Error ##

$minute = Get-Date -format "mm"
$minute_place = $minute.Substring(1,1)
$email_interval = "0"
$logger = Get-Content $logfile | Select-Object -Last 5

if( $minute_place -eq $email_interval -and $logger -match "error")
 {
 function SendAlert {
    try {
        $emailParams = @{
            From       = 'noreply@email.org'
            To         = 'email@email.org'
            Subject    = "GPS Monitor: Error"
            Body       = "$logger"
            SmtpServer = '11.11.11.11'
        }

        Send-MailMessage @emailParams
       # LogMessage "üìß ALERT: Sent empty file threshold email to $($emailParams.To)"
    } catch {
        #LogMessage "‚ùå ERROR sending email alert: $_"
    }
}
 
 SendAlert

}

    Start-Sleep -Seconds 5
}

